# üö® OWASP A01:2021 - Broken Access Control Vulnerability

## üîì **Vulnerability 3: A01:2021 ‚Äì Broken Access Control**

**Simple Explanation:** Anyone can access, modify, or delete ANY user's personal data without logging in!

---

## **üò± THE PROBLEM (Anyone Can Understand This!)**

### **Before Fix - COMPLETELY INSECURE:**

```javascript
// ‚ùå DANGER: Anyone can see ALL users' private information!
router.get("/", UserController.getAllUsers);           
// No authentication = Anyone can access!

// ‚ùå DANGER: Anyone can view ANY user's profile by guessing ID!
router.get("/:id", UserController.getById);           
// Example: GET /users/123 = See user 123's private data

// ‚ùå DANGER: Anyone can change ANY user's password/email!
router.put("/:id", UserController.updateUser);        
// Example: PUT /users/123 = Change user 123's password!

// ‚ùå DANGER: Anyone can delete ANY user account!
router.delete("/:id", UserController.deleteUser);     
// Example: DELETE /users/123 = Delete user 123's account!
```

### **Real-World Attack Examples:**

1. **Hacker can see everyone's data:**
   ```bash
   curl http://localhost:5000/users
   # Returns ALL users with emails, names, etc.
   ```

2. **Hacker can change YOUR password:**
   ```bash
   curl -X PUT http://localhost:5000/users/YOUR_ID \
        -d '{"password": "hacker123"}'
   # Your password is now "hacker123"!
   ```

3. **Hacker can delete YOUR account:**
   ```bash
   curl -X DELETE http://localhost:5000/users/YOUR_ID
   # Your account is deleted forever!
   ```

---

## **üõ°Ô∏è THE FIX - SECURE ACCESS CONTROL**

### **After Fix - PROPERLY SECURED:**

```javascript
// ‚úÖ SECURE: JWT Authentication + Authorization
const { authenticateToken, authorizeUser, requireAdmin } = require("../middleware/auth");

// Public routes (anyone can access)
router.post("/", UserController.addUsers);           // Registration - OK
router.post("/login", UserController.loginUser);     // Login - OK

// Protected routes (must be logged in) - OWASP A01:2021 Fix
router.get("/", authenticateToken, requireAdmin, UserController.getAllUsers);        
// ‚Üë Only ADMIN users can see all users

router.get("/:id", authenticateToken, authorizeUser, UserController.getById);        
// ‚Üë Users can ONLY see their OWN profile

router.put("/:id", authenticateToken, authorizeUser, UserController.updateUser);     
// ‚Üë Users can ONLY update their OWN profile

router.delete("/:id", authenticateToken, authorizeUser, UserController.deleteUser);  
// ‚Üë Users can ONLY delete their OWN account
```

### **Authentication Middleware:**

```javascript
// Checks if user has valid login token
const authenticateToken = async (req, res, next) => {
    const token = req.headers['authorization']?.split(' ')[1];
    
    if (!token) {
        return res.status(401).json({
            message: 'You must login first!'
        });
    }
    
    // Verify the token is valid and not expired
    const decoded = jwt.verify(token, JWT_SECRET);
    req.user = await User.findById(decoded.userId);
    next();
};

// Checks if user can access specific data
const authorizeUser = (req, res, next) => {
    const requestedUserId = req.params.id;
    const currentUserId = req.user._id.toString();
    
    // You can only access YOUR OWN data!
    if (currentUserId !== requestedUserId && !req.user.isAdmin) {
        return res.status(403).json({
            message: 'You can only access your own data!'
        });
    }
    next();
};
```

---

## **üìä BEFORE vs AFTER COMPARISON**

| Action | Before (Vulnerable) | After (Secure) |
|--------|-------------------|----------------|
| **View all users** | ‚ùå Anyone can access | ‚úÖ Admin only |
| **View user profile** | ‚ùå Anyone can see any profile | ‚úÖ Own profile only |
| **Change user data** | ‚ùå Anyone can change any data | ‚úÖ Own data only |
| **Delete account** | ‚ùå Anyone can delete any account | ‚úÖ Own account only |
| **Login required** | ‚ùå No login needed | ‚úÖ Must login with valid token |

---

## **üß™ PROOF OF FIX - Test Examples**

### **Test 1: Accessing Others' Data (Should Fail)**
```bash
# Try to access someone else's profile
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:5000/users/SOMEONE_ELSE_ID

# Response: 403 Forbidden
{
  "success": false,
  "message": "Access denied. You can only access your own data."
}
```

### **Test 2: Accessing Own Data (Should Work)**
```bash
# Access your own profile
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:5000/users/YOUR_ID

# Response: 200 OK
{
  "success": true,
  "user": { "name": "Your Name", "email": "your@email.com" }
}
```

### **Test 3: No Token (Should Fail)**
```bash
# Try to access without login token
curl http://localhost:5000/users/123

# Response: 401 Unauthorized
{
  "success": false,
  "message": "Access denied. No authentication token provided."
}
```

---

## **üéØ SECURITY IMPROVEMENT SUMMARY**

**What This Fix Prevents:**
1. ‚úÖ **Identity Theft** - No one can access your personal data
2. ‚úÖ **Account Takeover** - No one can change your password
3. ‚úÖ **Data Breach** - Hackers can't see all user information
4. ‚úÖ **Account Deletion** - No one can delete your account
5. ‚úÖ **Unauthorized Actions** - Must login to do anything

**How It Works:**
1. **Login Required** - Must have valid JWT token
2. **Identity Verification** - Token proves who you are
3. **Permission Check** - Can only access your own data
4. **Admin Controls** - Special permissions for admin users
5. **Token Expiry** - Tokens expire after 24 hours for security

This fix transforms the application from **completely insecure** to **properly protected** following OWASP guidelines!
